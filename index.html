<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <title>Escape the Phasor ‚Äì Wireframe v2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --metal-1:#4A4E52; --metal-2:#565A60; --metal-3:#2E3135;
      --cream:#FCF6E6; --grid:#C6FFFF; --grid-10:#9EEFEF;
      --ok:#23c55e; --fail:#ff3b3b; --hud:#1f2937; --hudText:#f8fafc;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0f1216,#171a1f);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .frame{
      max-width:1280px;margin:24px auto;padding:16px;
      background:linear-gradient(135deg,var(--metal-2),var(--metal-3));
      border:6px solid var(--metal-1);border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.4);position:relative;
    }
    .frame::before,.frame::after{content:"";position:absolute;width:14px;height:14px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#d6cba8 0 40%,#867f6a 60% 100%);box-shadow:inset 0 0 2px rgba(0,0,0,.5)}
    .frame::before{left:10px;top:10px}.frame::after{right:10px;top:10px}
    .row{display:flex;gap:16px}
    .top{align-items:center;position:relative;z-index:2}
    .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:12px;
      backdrop-filter:blur(2px);color:#e5e7eb;min-height:120px}
    .dr,.student{flex:0 0 23%}
    .task{flex:1;min-height:160px;position:relative;display:flex;flex-direction:column;padding-top:48px}
    .task h2{margin:0 0 8px 0;font-size:18px}
    .task .scroll{overflow:auto;max-height:120px;padding-right:8px}
    /* Bublina nad panelom zadania */
    .bubble.wide{position:absolute;left:0;right:0;top:-10px;max-width:none;width:calc(100% - 8px);
      background:#fff;color:#111;border-radius:12px;padding:10px 36px 10px 12px;box-shadow:0 10px 20px rgba(0,0,0,.25);border:2px solid #6b4ca6;
      transform:translateY(-100%)}
    .bubble.wide:after{content:"";position:absolute;bottom:-10px;left:40px;border:10px solid transparent;border-top-color:#fff;
      filter:drop-shadow(0 -2px 0 #6b4ca6)}
    .bubble .close{position:absolute;right:8px;top:4px;width:24px;height:24px;display:grid;place-items:center;cursor:pointer;
      font-weight:700;border-radius:6px;color:#6b4ca6}
    .bubble .close:hover{background:#f2eaff}
/* scope = r√°m osciloskopu */
.scope{
  position:absolute; inset:12px 18px 64px 18px;   /* men≈°ia plocha, miesto dole pre UI */
  background:#0d0f11; border-radius:14px; padding:10px;
  box-shadow: inset 0 0 0 2px #2a3039, inset 0 0 20px rgba(0,0,0,.6);
}
/* vn√∫torn√Ω ‚Äûscreen‚Äú je samotn√© canvas */
#osc{ width:100%; height:100%; display:block; border-radius:10px; }

/* UI pod scope u≈æ m√°me ‚Äì nech√°me ako je */

/* kalkulaƒçka */
/* ===== Kalkulaƒçka ===== */
const calc = {
  disp: document.getElementById('calcDisplay'),
  modeBtn: document.getElementById('degRad'),
  grid: document.querySelector('.calc-grid'),
  rad: true,     // RAD/DEG prep√≠naƒç (true=RAD)
};

calc.modeBtn.addEventListener('click', ()=>{
  calc.rad = !calc.rad;
  calc.modeBtn.textContent = calc.rad ? 'RAD' : 'DEG';
  calc.modeBtn.title = calc.rad ? 'Radi√°ny' : 'Stupne';
});

function insertToDisplay(s){ calc.disp.value += s; calc.disp.focus(); }
function delOne(){ calc.disp.value = calc.disp.value.slice(0,-1); }
function clearDisp(){ calc.disp.value=''; }

function evalExpr(){
  // nahradi≈• ^ ‚Üí **, œÄ, e
  let expr = calc.disp.value.replaceAll('^','**')
                            .replaceAll('œÄ', Math.PI.toString())
                            .replaceAll('e', Math.E.toString());

  // nahradi≈• funkcie sin/cos/tan/sqrt
  // s DEG/RAD re≈æimom
  const wrapTrig = fn => (calc.rad? fn : (x)=>fn(x*Math.PI/180));
  const scope = {
    sin: x=>wrapTrig(Math.sin)(x),
    cos: x=>wrapTrig(Math.cos)(x),
    tan: x=>wrapTrig(Math.tan)(x),
    sqrt: Math.sqrt
  };

  // bezpeƒçn√Ω eval: new Function + obmedzen√Ω scope
  try{
    const f = new Function('sin','cos','tan','sqrt',`return (${expr})`);
    const val = f(scope.sin,scope.cos,scope.tan,scope.sqrt);
    if(Number.isFinite(val)){ return val; }
    return NaN;
  }catch(e){ return NaN; }
}

calc.grid.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const num = b.getAttribute('data-num');
  const op  = b.getAttribute('data-op');
  const fn  = b.getAttribute('data-fn');

  if(num!==null) insertToDisplay(num);
  else if(op!==null) insertToDisplay(op);
  else if(fn){
    if(fn==='pi') insertToDisplay('œÄ');
    else if(fn==='e') insertToDisplay('e');
    else if(fn==='sin' || fn==='cos' || fn==='tan' || fn==='sqrt') insertToDisplay(fn+'(');
    else if(fn==='del') delOne();
    else if(fn==='clear') clearDisp();
    else if(fn==='eq'){
      const v = evalExpr();
      calc.disp.value = Number.isFinite(v) ? v : 'NaN';
    }
    else if(fn==='ans'){
      const v = evalExpr();
      if(Number.isFinite(v)){
        document.getElementById('answer').value = (Math.round(v*100)/100).toFixed(2);
      }
    }
  }
});
   
.calc{ position:absolute; top:18px; left:18px; right:18px; bottom:110px;
  background:rgba(255,255,255,.75); border:1px solid rgba(0,0,0,.1);
  border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px;
  box-shadow:0 3px 10px rgba(0,0,0,.08); color:#111;
}
.calc-top{ display:flex; gap:8px; }
#calcDisplay{
  flex:1; padding:8px 10px; border:1px solid #c9c9c9; border-radius:8px; font-size:16px;
}
#degRad{ padding:8px 10px; border-radius:8px; border:1px solid #374151; background:#111827; color:#f8fafc; cursor:pointer; }
.calc-grid{ display:grid; grid-template-columns: repeat(5, 1fr); gap:6px; }
.calc-grid button{
  padding:8px 10px; border:1px solid #bdbdbd; border-radius:8px; background:#f3f4f6; cursor:pointer; font-weight:600;
}
.calc-grid button.wide{ grid-column: span 2; }
.calc-grid button.ghost{ background:#e5e7eb; }
.calc-grid button.emph{ background:#111827; color:#f8fafc; border-color:#1f2937; }

/* drobnosti */
.answerBox{ bottom:18px; }

    /* Z√°mky */
    .locks{display:flex;flex-direction:column;gap:6px;margin-left:auto}
    .lock{width:26px;height:26px;border-radius:6px;background:#0e1218;border:1px solid #2a3039;display:grid;place-items:center;color:#fcd34d;font-size:16px;
      box-shadow:inset 0 0 6px rgba(0,0,0,.6)}
    /* Pl√°tno ‚Äì jeden veƒæk√Ω h√°rok papiera */
    .play{margin-top:16px;position:relative;z-index:1}
    .workbench{
     <div class="workbench">
  <!-- ƒΩAV√Å z√≥na: osciloskop s r√°mom -->
  <div class="zone left">
    <div class="scope">
      <canvas id="osc" aria-label="osciloskop"></canvas>
    </div>
    <div class="osc-ui">
      <button id="playBtn" type="button">‚ñ∂Ô∏é Play</button>
      <label>ƒåas <var>t</var>:
        <input id="tSlider" type="range" min="0" max="20" step="0.1" value="2">
        <span id="tReadout">2.0 ms</span>
      </label>
    </div>
  </div>

  <!-- Prav√° z√≥na: VEDECK√Å KALKULAƒåKA + odpoveƒè -->
  <div class="zone right">
    <div class="calc" id="calc">
      <div class="calc-top">
        <input id="calcDisplay" type="text" inputmode="decimal" autocomplete="off" spellcheck="false" />
        <button id="degRad">RAD</button>
      </div>
      <div class="calc-grid">
        <!-- riadok 1 -->
        <button data-fn="pi">œÄ</button>
        <button data-fn="e">e</button>
        <button data-op="^">^</button>
        <button data-op="(">(</button>
        <button data-op=")">)</button>
        <!-- riadok 2 -->
        <button data-fn="sin">sin</button>
        <button data-fn="cos">cos</button>
        <button data-fn="tan">tan</button>
        <button data-fn="sqrt">‚àö</button>
        <button data-op="/">√∑</button>
        <!-- riadok 3 -->
        <button data-num="7">7</button>
        <button data-num="8">8</button>
        <button data-num="9">9</button>
        <button data-op="*">√ó</button>
        <button data-op="-">‚àí</button>
        <!-- riadok 4 -->
        <button data-num="4">4</button>
        <button data-num="5">5</button>
        <button data-num="6">6</button>
        <button data-op="+">+</button>
        <button data-fn="del">DEL</button>
        <!-- riadok 5 -->
        <button data-num="1">1</button>
        <button data-num="2">2</button>
        <button data-num="3">3</button>
        <button data-num="0" class="wide">0</button>
        <button data-op=".">.</button>
        <!-- riadok 6 -->
        <button data-fn="clear" class="ghost">C</button>
        <button data-fn="ans"   class="ghost">‚Üí Odpoveƒè</button>
        <button data-fn="eq"    class="emph">=</button>
      
      </div>
    </div>

    <div class="answerBox">
      <label>Odpoveƒè: <var>u</var>(<var>t</var>) =
        <input id="answer" type="number" step="0.01" placeholder="V">
        <span>V</span>
      </label>
      <button id="checkBtn">Skontrolova≈•</button>
      <div id="feedback" class="feedback"></div>
    </div>
  </div>
</div>

<!-- iskra pri √∫spechu -->
<div id="spark" class="spark" aria-hidden="true"></div>

    }
    @media (max-width:1280px){.workbench{min-height:360px}}
    .workbench::before{content:"";position:absolute;inset:0;background:
      repeating-linear-gradient(0deg,var(--grid) 0 1px,transparent 1px 20px),
      repeating-linear-gradient(90deg,var(--grid) 0 1px,transparent 1px 20px),
      repeating-linear-gradient(0deg,transparent 0 200px,var(--grid-10) 200px 201px,transparent 201px 400px),
      repeating-linear-gradient(90deg,transparent 0 200px,var(--grid-10) 200px 201px,transparent 201px 400px);
      opacity:.55;pointer-events:none}
    .zone{position:absolute;top:0;bottom:0}
    .zone.left{left:0;right:50%}.zone.right{left:50%;right:0}
    /* Osciloskop */
   function drawOsc(){
  if(!oscCtx) resizeOsc();
  // rozmery vn√∫torn√©ho screen (canvas u≈æ sed√≠ na scope vn√∫tri)
  oscCtx.clearRect(0,0,el.osc.width, el.osc.height);

  const DPR = window.devicePixelRatio || 1;
  const W = el.osc.width / DPR;
  const H = el.osc.height / DPR;

  // ‚Äûmrie≈ækov√Ω‚Äú krok = 20 px ‚Üí okraj 2 ≈°tvorƒçeky
  const G = 20;
  const PAD = 2 * G;         // 2 ≈°tvorƒçeky
  const xmin = PAD, xmax = W - PAD;
  const ymin = PAD, ymax = H - PAD;

  // osy (ƒçierna)
  const midX = (xmin + xmax)/2;
  const midY = (ymin + ymax)/2;
  oscCtx.save();
  oscCtx.scale(DPR, DPR);
  oscCtx.strokeStyle = '#111';
  oscCtx.lineWidth = 1.5;
  // horizont√°lna
  oscCtx.beginPath(); oscCtx.moveTo(xmin, midY); oscCtx.lineTo(xmax, midY); oscCtx.stroke();
  // vertik√°lna
  oscCtx.beginPath(); oscCtx.moveTo(midX, ymin); oscCtx.lineTo(midX, ymax); oscCtx.stroke();

  // ƒçasov√° os ‚Äì zobraz√≠me ~2 peri√≥dy v [xmin,xmax]
  const T = 1/state.f;                // s
  const viewT = 2*T;
  const tToX = t => xmin + (t/viewT)*(xmax - xmin);

  // men≈°ia amplit√∫da ‚Äì dr≈æ√≠me 0.28 v√Ω≈°ky (v r√°mci vn√∫torn√©ho r√°mu)
  const A = ( (ymax - ymin) * 0.28 );
  const phi = deg2rad(state.phi);
  const wang = TAU*state.f;

  // sinus (zelen√°)
  oscCtx.strokeStyle = '#159447';
  oscCtx.lineWidth = 2;
  oscCtx.beginPath();
  const STEPS = Math.max(200, (xmax-xmin)); // hladkos≈•
  for(let i=0;i<=STEPS;i++){
    const x = xmin + (i/STEPS)*(xmax-xmin);
    const t = ( (x - xmin) / (xmax - xmin) ) * viewT;
    const y = midY - A * Math.sin(wang*t + phi);
    if(i===0) oscCtx.moveTo(x,y); else oscCtx.lineTo(x,y);
  }
  oscCtx.stroke();

  // be≈æiaca bodka (play/slider)
  const Tms = 1000/state.f;
  const tms = state.playing ? state.tAnim : +el.tSlider.value;
  const t = (tms/1000) % viewT;
  const x = tToX(t);
  const y = midY - A * Math.sin(wang*t + phi);
  oscCtx.fillStyle = '#0aff6c';
  oscCtx.beginPath(); oscCtx.arc(x,y,4,0,TAU); oscCtx.fill();

  // text
  const uval = u_of_t_ms(tms);
  oscCtx.fillStyle = 'rgba(0,0,0,.75)';
  oscCtx.font = '600 12px system-ui';
  oscCtx.fillText(`u(${tms.toFixed(1)} ms) ‚âà ${round2(uval).toFixed(2)} V`, xmin+4, ymin+14);
  oscCtx.restore();
}

    /* Prav√° z√≥na ‚Äì krabiƒçky */
    .taskBox,.answerBox{position:absolute;left:18px;right:18px;background:rgba(255,255,255,.7);border:1px solid rgba(0,0,0,.1);
      border-radius:12px;padding:12px;color:#111;box-shadow:0 3px 10px rgba(0,0,0,.08)}
    .taskBox{top:18px}.taskBox .line{margin:2px 0}.taskBox .small{opacity:.8}
    .answerBox{bottom:18px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .answerBox input{width:140px;padding:6px 8px;border-radius:8px;border:1px solid #c9c9c9}
    .answerBox button{padding:8px 14px;border-radius:10px;border:1px solid #1f2937;background:#111827;color:#f8fafc;cursor:pointer}
    .feedback{min-height:1.2em;font-weight:700}
    /* Spodn√Ω HUD */
    .hud{margin-top:12px;padding:10px 12px;background:var(--hud);color:var(--hudText);border-radius:var(--radius);
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;position:relative;z-index:3}
    .hud .group{display:flex;gap:14px;align-items:center}
    .pill{background:#111827;padding:6px 10px;border-radius:999px;border:1px solid #374151}
    .hud select{background:#111827;color:#f8fafc;border:1px solid #374151;border-radius:8px;padding:3px 6px}
    /* Typografia */
    .math var{font-style:italic}.math sub{font-style:normal}.phi{font-family:"Cambria Math","STIX Two Math","DejaVu Sans",serif}
    .shake{animation:shake .35s}.flash{animation:flash .4s}
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    @keyframes flash{0%{background:#2b1111}100%{background:transparent}}
    /* Iskra */
    .spark{position:absolute;width:160px;height:160px;pointer-events:none;display:none;background:
      radial-gradient(circle at 50% 50%,#FFD745 0 30%,rgba(255,215,69,.6) 35% 55%,transparent 60%),
      conic-gradient(from 0deg,rgba(255,215,69,.9),rgba(243,190,87,.6),rgba(255,237,154,.7),rgba(255,215,69,.9));
      filter:blur(1px) drop-shadow(0 0 10px rgba(255,215,69,.7));border-radius:50%;
      transform:translate(-50%,-50%) scale(.8);animation:spark .6s ease-out forwards}
    @keyframes spark{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.4) rotate(0deg)}
      20%{opacity:1;transform:translate(-50%,-50%) scale(1.05) rotate(12deg)}
      100%{opacity:0;transform:translate(-50%,-50%) scale(1.1) rotate(22deg)}
    }
  </style>
</head>
<body>
  <main class="frame">
    <!-- Horn√Ω rad -->
    <section class="row top">
      <div class="panel dr" id="dr">
        <strong>Dr. Phasor</strong>
      </div>

      <div class="panel task" id="taskPanel">
        <!-- Bublina na ≈°√≠rku panelu -->
        <div class="bubble wide" id="bubble">
          MUHAHA! Nov√© zadanie ƒçak√°‚Ä¶
          <div class="close" id="bubbleClose">√ó</div>
        </div>
        <h2>√öloha</h2>
        <div class="scroll math" id="taskText">
          Vypoƒç√≠taj <var>u</var>(<var>t</var>) pri <var>U</var>=230&nbsp;V, <var>f</var>=50&nbsp;Hz, <span class="phi">œÜ</span>=10¬∞.
          <br>Vzorec: <var>u</var>(<var>t</var>) = <var>U</var><sub>m</sub> sin(<var>œât</var> + <span class="phi">œÜ</span>)
        </div>
      </div>

      <div class="panel student">
        <strong>≈†tudent</strong>
        <div class="locks" aria-label="Z√°mky" id="locksCol">
          <div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div>
          <div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div>
        </div>
      </div>
    </section>

    <!-- Pl√°tno -->
    <section class="play">
      <div class="workbench">
        <!-- ƒΩAV√Å z√≥na: osciloskop -->
        <div class="zone left">
          <canvas id="osc" aria-label="osciloskop"></canvas>
          <div class="osc-ui">
            <button id="playBtn" type="button">‚ñ∂Ô∏é Play</button>
            <label>ƒåas <var>t</var>:
              <input id="tSlider" type="range" min="0" max="20" step="0.1" value="2">
              <span id="tReadout">2.0 ms</span>
            </label>
          </div>
        </div>

        <!-- Prav√° z√≥na: zadanie + odpoveƒè -->
        <div class="zone right">
          <div class="taskBox math" id="taskBox">
            <div class="line"><strong>Zadanie:</strong> Vypoƒç√≠taj <var>u</var>(<var>t</var>) v ƒçase <span id="tGiven">2.0</span> ms pre</div>
            <div class="line">&nbsp;&nbsp;<var>u</var>(<var>t</var>) = <var>U</var><sub>m</sub> sin(<var>œât</var> + <span class="phi">œÜ</span>)</div>
            <div class="line small">&nbsp;&nbsp;kde <var>U</var><sub>m</sub> = ‚àö2 ¬∑ <var>U</var></div>
            <div class="line">Parametre: <var>U</var> = <span id="Ueff">230</span> V,&nbsp; <var>f</var> = <span id="freq">50</span> Hz,&nbsp; <span class="phi">œÜ</span> = <span id="phiDeg">10</span>¬∞</div>
          </div>

          <div class="answerBox">
            <label>Odpoveƒè: <var>u</var>(<var>t</var>) =
              <input id="answer" type="number" step="0.01" placeholder="V">
              <span>V</span>
            </label>
            <button id="checkBtn">Skontrolova≈•</button>
            <div id="feedback" class="feedback"></div>
          </div>
        </div>
      </div>

      <!-- efekt iskry pri √∫spechu -->
      <div id="spark" class="spark" aria-hidden="true"></div>
    </section>

    <!-- HUD -->
    <section class="hud" id="hud">
      <div class="group">
        <span class="pill" id="timePill">TIME: 00:00</span>
        <span class="pill">
          MODE:
          <select id="modeSelect" style="margin-left:6px">
            <option value="EASY" selected>EASY</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HARD">HARD</option>
          </select>
        </span>
        <span class="pill" id="mistakesPill">MISTAKES: 0/2</span>
        <span class="pill" id="locksPill">LOCKS LEFT: 10</span>
      </div>
      <div class="group">
        <button class="pill" id="hintBtn">HINT</button>
      </div>
    </section>
  </main>

  <script>
    // zatvorenie bubliny len cez X
    document.getElementById('bubbleClose').addEventListener('click',()=>document.getElementById('bubble').style.display='none');

    /* ===== Stav hry ===== */
    const pills = {
      mistakes: document.getElementById('mistakesPill'),
      locks: document.getElementById('locksPill'),
      time: document.getElementById('timePill')
    };
    let startTs = Date.now();

    const state = {
      mode:'EASY', mistakes:0,
      U:230, f:50, phi:10, tGiven:2.0,  // zadanie
      playing:false, tAnim:2.0          // osciloskop
    };

    const el = {
      Ueff:document.getElementById('Ueff'), freq:document.getElementById('freq'), phiDeg:document.getElementById('phiDeg'), tGiven:document.getElementById('tGiven'),
      tSlider:document.getElementById('tSlider'), tRead:document.getElementById('tReadout'), play:document.getElementById('playBtn'),
      answer:document.getElementById('answer'), check:document.getElementById('checkBtn'), feedback:document.getElementById('feedback'),
      bubble:document.getElementById('bubble'), taskPanel:document.getElementById('taskPanel'),
      osc:document.getElementById('osc'), spark:document.getElementById('spark'),
      modeSelect:document.getElementById('modeSelect'), locksCol:document.getElementById('locksCol')
    };

    // pomocn√≠ci
    const TAU=Math.PI*2, deg2rad=d=>d*Math.PI/180, round2=x=>Math.round(x*100)/100;
    const randFrom=a=>a[Math.floor(Math.random()*a.length)];
    function tolByMode(){ return state.mode==='EASY'?0.50 : state.mode==='MEDIUM'?0.20 : 0.05; }

    // nov√© zadanie
    function newTask1(){
      state.mistakes=0;
      state.U = randFrom([230,120,100,60]);
      state.f = 50; // zatiaƒæ
      state.phi = randFrom([-30,-15,0,10,15,30]);
      const Tms = 1000/state.f;
      state.tGiven = +( (Math.random()*Tms).toFixed(1) );

      el.Ueff.textContent=state.U;
      el.freq.textContent=state.f;
      el.phiDeg.textContent=state.phi;
      el.tGiven.textContent=state.tGiven.toFixed(1);

      el.tSlider.max=Tms.toFixed(1);
      el.tSlider.value=state.tGiven;
      el.tRead.textContent=state.tGiven.toFixed(1)+' ms';
      state.tAnim=state.tGiven;

      el.answer.value=''; el.feedback.textContent='';
      resizeOsc(); drawOsc(); updateHud();
    }

    // u(t) v ms
    function u_of_t_ms(tms){
      const Um=Math.SQRT2*state.U, w=TAU*state.f, t=tms/1000, phi=deg2rad(state.phi);
      return Um*Math.sin(w*t+phi);
    }

    /* ===== Osciloskop ===== */
    let oscCtx,w,h,DPR=window.devicePixelRatio||1, rafId=null,lastTs=0,audioCtx=null;
    function resizeOsc(){
      const r=el.osc.getBoundingClientRect(); w=Math.floor(r.width*DPR); h=Math.floor(r.height*DPR);
      el.osc.width=w; el.osc.height=h; oscCtx=el.osc.getContext('2d'); oscCtx.setTransform(DPR,0,0,DPR,0,0);
    }
    function drawOsc(){
      if(!oscCtx) resizeOsc();
      oscCtx.clearRect(0,0,el.osc.width,el.osc.height);
      const midY=h/DPR/2;
      // osov√° ƒçiara
      oscCtx.strokeStyle='rgba(0,0,0,.12)'; oscCtx.lineWidth=1;
      oscCtx.beginPath(); oscCtx.moveTo(0,midY); oscCtx.lineTo(w/DPR,midY); oscCtx.stroke();

      const T=1/state.f, viewT=2*T, tToX=t=>(t/viewT)*(w/DPR);
      const A=(h/DPR)*0.36, phi=deg2rad(state.phi), wang=TAU*state.f;

      // sinus
      oscCtx.strokeStyle='#159447'; oscCtx.lineWidth=2; oscCtx.beginPath();
      for(let px=0; px<=w/DPR; px++){
        const t=(px/(w/DPR))*viewT, y=midY - A*Math.sin(wang*t+phi);
        if(px===0) oscCtx.moveTo(px,y); else oscCtx.lineTo(px,y);
      } oscCtx.stroke();

      // bodka
      const Tms=1000/state.f, tms=state.playing?state.tAnim:+el.tSlider.value, t=(tms/1000)%viewT;
      const x=tToX(t), y=midY - A*Math.sin(wang*t+phi);
      oscCtx.fillStyle='#0aff6c'; oscCtx.beginPath(); oscCtx.arc(x,y,4,0,TAU); oscCtx.fill();

      // text
      const uval=u_of_t_ms(tms);
      oscCtx.fillStyle='rgba(0,0,0,.7)'; oscCtx.font='600 12px system-ui';
      oscCtx.fillText(`u(${tms.toFixed(1)} ms) ‚âà ${round2(uval).toFixed(2)} V`,8,16);
    }
    function loop(ts){
      if(!state.playing){ rafId=null; return; }
      if(!lastTs) lastTs=ts; const dt=(ts-lastTs)/1000; lastTs=ts;
      const Tms=1000/state.f; const prev=state.tAnim; state.tAnim+=dt*1000;
      if(state.tAnim>=Tms){ state.tAnim-=Tms; beep(); }
      el.tSlider.value=state.tAnim.toFixed(1); el.tRead.textContent=el.tSlider.value+' ms';
      drawOsc(); rafId=requestAnimationFrame(loop);
    }
    el.play.addEventListener('click',()=>{
      state.playing=!state.playing; el.play.textContent = state.playing?'‚è∏Ô∏é Pause':'‚ñ∂Ô∏é Play';
      el.play.classList.toggle('paused',!state.playing);
      if(state.playing){ lastTs=0; rafId=requestAnimationFrame(loop); } else if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
    });
    window.addEventListener('resize',()=>{ resizeOsc(); drawOsc(); });
    el.tSlider.addEventListener('input',e=>{
      el.tRead.textContent=(+e.target.value).toFixed(1)+' ms';
      if(!state.playing) state.tAnim=+e.target.value;
      drawOsc();
    });

    // pip
    function beep(){
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sine'; o.frequency.value=880; g.gain.value=0.04;
      o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.08);
    }

    /* ===== Checker (0,01 V + tolerancia podƒæa m√≥du) ===== */
    el.check.addEventListener('click',()=>{
      const ans=+el.answer.value; if(Number.isNaN(ans)){ el.feedback.textContent='Zadaj ƒç√≠slo (V).'; return; }
      const corR = round2(u_of_t_ms(state.tGiven)), ansR = round2(ans), tol = tolByMode();
      if(Math.abs(ansR - corR) <= tol){
        el.feedback.textContent=`Spr√°vne! u(t) ‚âà ${corR.toFixed(2)} V üîì`; el.feedback.style.color='#159447';
        dropOneLock(); successSpark(); newTask1();
      }else{
        state.mistakes++; failFeedback();
        if(state.mode==='EASY' && state.mistakes===1){
          el.feedback.textContent='N√°poveda: U_m = ‚àö2¬∑U a œâ = 2œÄf. t v sekund√°ch.'; el.feedback.style.color='#b45309';
        }else if(state.mistakes>=2){
          el.feedback.textContent='MUHAHA! Nov√© zadanie.'; el.feedback.style.color='#ff3b3b';
          showMuhaha(); newTask1();
        }else{
          el.feedback.textContent='Sk√∫s e≈°te raz.'; el.feedback.style.color='#ff3b3b';
        }
      }
      updateHud();
    });
    function failFeedback(){ const p=el.taskPanel; p.classList.add('shake','flash'); setTimeout(()=>p.classList.remove('shake','flash'),450); }
    function showMuhaha(){
      el.bubble.style.display='block'; el.bubble.innerHTML='MUHAHA! Nov√© zadanie‚Ä¶<div class="close" id="bubbleClose2">√ó</div>';
      document.getElementById('bubbleClose2').addEventListener('click',()=>el.bubble.style.display='none');
    }

    // z√°mok preƒç + iskra
    function dropOneLock(){
      const locks = el.locksCol.querySelectorAll('.lock');
      if(locks.length){ locks[0].remove(); }
    }
    function successSpark(){
      const drRect=document.getElementById('dr').getBoundingClientRect();
      const frameRect=document.querySelector('.frame').getBoundingClientRect();
      el.spark.style.display='block';
      el.spark.style.left=(drRect.right - frameRect.left - 20)+'px';
      el.spark.style.top =(drRect.top   - frameRect.top  + 30)+'px';
      el.spark.classList.remove('spark'); void el.spark.offsetWidth; el.spark.classList.add('spark');
      setTimeout(()=>{ el.spark.style.display='none'; },650);
    }

    // HUD + m√≥d + ƒças
    function updateHud(){
      const left = el.locksCol.querySelectorAll('.lock').length;
      pills.mistakes.textContent=`MISTAKES: ${state.mistakes}/2`;
      pills.locks.textContent   =`LOCKS LEFT: ${left}`;
    }
    el.modeSelect.addEventListener('change',e=>{ state.mode=e.target.value; });
    setInterval(()=>{ const s=Math.floor((Date.now()-startTs)/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0');
      pills.time.textContent=`TIME: ${m}:${ss}`; },1000);

    // ≈°tart
    function boot(){ resizeOsc(); newTask1(); updateHud(); }
    boot();
  </script>
</body>
</html>
