<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <title>Escape the Phasor ‚Äì √öloha 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --metal-1:#4A4E52; --metal-2:#565A60; --metal-3:#2E3135;
      --cream:#FCF6E6; --grid:#C6FFFF; --grid-10:#9EEFEF;
      --ok:#22c55e; --fail:#ef4444; --hud:#111827; --hudText:#f9fafb;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#020817,#111827);
      color:#e5e7eb;
    }

    /* R√ÅM */
    .frame{
      max-width:1280px;
      margin:24px auto;
      padding:16px;
      background:linear-gradient(135deg,var(--metal-2),var(--metal-3));
      border:6px solid var(--metal-1);
      border-radius:18px;
      box-shadow:0 10px 40px rgba(0,0,0,.4);
      position:relative;
    }
    .frame::before,.frame::after{
      content:"";
      position:absolute;
      width:14px;height:14px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#d6cba8 0 40%,#867f6a 60% 100%);
      box-shadow:inset 0 0 2px rgba(0,0,0,.6);
    }
    .frame::before{left:10px;top:10px}
    .frame::after{right:10px;top:10px}

    .row{display:flex;gap:16px}
    .top{align-items:center;position:relative;z-index:2}

    /* PANELY HORE */
    .panel{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:12px;
      backdrop-filter:blur(2px);
      min-height:120px;
    }
    .panel strong{display:block;margin-bottom:4px}
    .dr,.student{flex:0 0 23%}
    .task{
      flex:1;
      min-height:160px;
      position:relative;
      display:flex;
      flex-direction:column;
      padding-top:48px;
    }
    .task h2{margin:0 0 8px 0;font-size:18px}
    .task .scroll{overflow:auto;max-height:120px;padding-right:8px}

    /* Bublina Dr. Phasora */
    .bubble.wide{
      position:absolute;
      left:0;right:0;top:-10px;
      width:calc(100% - 8px);
      background:#ffffff;
      color:#111827;
      border-radius:12px;
      padding:10px 36px 10px 12px;
      box-shadow:0 10px 20px rgba(0,0,0,.25);
      border:2px solid #6b4ca6;
      transform:translateY(-100%);
    }
    .bubble.wide:after{
      content:"";
      position:absolute;
      bottom:-10px;left:40px;
      border:10px solid transparent;
      border-top-color:#ffffff;
      filter:drop-shadow(0 -2px 0 #6b4ca6);
    }
    .bubble .close{
      position:absolute;right:8px;top:4px;
      width:24px;height:24px;
      display:grid;place-items:center;
      cursor:pointer;
      border-radius:6px;
      font-weight:700;
      color:#6b4ca6;
    }
    .bubble .close:hover{background:#f2eaff}

    /* Z√ÅMKY */
    .locks{
      display:flex;flex-direction:column;gap:6px;margin-left:auto;
    }
    .lock{
      width:26px;height:26px;border-radius:6px;
      background:#020817;border:1px solid #374151;
      display:grid;place-items:center;
      color:#fbbf24;font-size:16px;
      box-shadow:inset 0 0 6px rgba(0,0,0,.7);
    }

    /* PL√ÅTNO / WORKBENCH */
    .play{margin-top:16px;position:relative;z-index:1}
    .workbench{
      width:100%;
      aspect-ratio:16/9;
      min-height:420px;
      background:var(--cream);
      border:1px solid rgba(0,0,0,.12);
      border-radius:var(--radius);
      position:relative;
      overflow:hidden;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.04);
    }
    @media (max-width:1280px){.workbench{min-height:360px}}
    .workbench::before{
      content:"";
      position:absolute;inset:0;
      background:
        repeating-linear-gradient(0deg,var(--grid) 0 1px,transparent 1px 20px),
        repeating-linear-gradient(90deg,var(--grid) 0 1px,transparent 1px 20px),
        repeating-linear-gradient(0deg,transparent 0 200px,var(--grid-10) 200px 201px,transparent 201px 400px),
        repeating-linear-gradient(90deg,transparent 0 200px,var(--grid-10) 200px 201px,transparent 201px 400px);
      opacity:.45;
      pointer-events:none;
    }

   .zone{
      position:absolute;
      top:0;
      bottom:0;
    }

    .zone.left{
      left:0;
      width:50%;
    }

    .zone.right{
      right:0;
      width:50%;
    }


    /* OSCILOSKOP */
   .scope{
      position:absolute;
      top:18px;
      left:18px;
      right:18px;
      bottom:82px;              /* rovnak√© ƒç√≠slo ako pri .calc */
      background:#0d0f11;
      border-radius:14px;
      padding:10px;
      box-shadow: inset 0 0 0 2px #2a3039,
              inset 0 0 20px rgba(0,0,0,.6);
    }

    #osc{
      width:100%;height:100%;
      display:block;
      border-radius:10px;
    }

    .osc-ui{
      position:absolute;
      left:18px;
      right:18px;
      bottom:18px;  /* zarovn√°me s answerBoxom vpravo */
      display:flex;gap:16px;align-items:center;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(0,0,0,.08);
      border:1px solid rgba(15,23,42,.3);
      backdrop-filter:blur(1px);
      color:#111827;
    }
    #playBtn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #111827;
      background:#111827;
      color:#f9fafb;
      cursor:pointer;
    }
    #playBtn.paused{opacity:.7}
    .osc-ui input[type="range"]{width:220px;margin:0 8px}

    /* KALKULAƒåKA */
    .calc{
      position:absolute;
      top:18px;
      left:18px;
      right:18px;
      bottom:82px; /* rovnak√° logika ako scope + miesto na answerBox */
      background:rgba(255,255,255,.78);
      border:1px solid rgba(0,0,0,.1);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:0 3px 10px rgba(0,0,0,.08);
      color:#111827;
    }
    .calc-top{display:flex;gap:8px;}
    #calcDisplay{
      flex:1;
      padding:8px 10px;
      border:1px solid #cbd5e1;
      border-radius:8px;
      font-size:16px;
    }
    #degRad{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #111827;
      background:#111827;
      color:#f9fafb;
      cursor:pointer;
    }
    .calc-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr); /* 3 stƒ∫pce numpad + 1 stƒ∫pec funkci√≠ */
      gap:6px;
}

    .calc-grid button{
      padding:18px 0;
      border:2px solid #d4d4d8;
      border-radius:12px;
      background:#f4f4f5;
      cursor:pointer;
      font-weight:800;
      font-size:16px;
    }
    .calc-grid button.wide{grid-column:span 2;}
    .calc-grid button.ghost{background:#e5e7eb;}
    .calc-grid button.emph{
      background:#111827;
      color:#f9fafb;
      border-color:#111827;
    }

    /* ODPOVEƒé */
    .answerBox{
  position:absolute;
  left:18px;
  right:18px;
  bottom:18px;              /* rovnak√© ako .osc-ui ‚Üí jedna l√≠nia */
  background:rgba(255,255,255,.9);
  border:1px solid rgba(0,0,0,.1);
  border-radius:12px;
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  color:#111;
  box-shadow:0 3px 8px rgba(0,0,0,.06);
}
    .answerBox input{
      width:140px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #cbd5e1;
    }
    .answerBox button{
      padding:8px 14px;
      border-radius:10px;
      border:1px solid #111827;
      background:#111827;
      color:#f9fafb;
      cursor:pointer;
    }
    .feedback{min-height:1.2em;font-weight:700}

    /* HUD */
    .hud{
      margin-top:12px;
      padding:10px 12px;
      background:var(--hud);
      color:var(--hudText);
      border-radius:var(--radius);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      position:relative;
      z-index:3;
      font-size:14px;
    }
    .hud .group{display:flex;gap:14px;align-items:center}
    .pill{
      background:#020817;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #374151;
    }
    .hud select{
      background:#020817;
      color:#f9fafb;
      border:1px solid #374151;
      border-radius:8px;
      padding:3px 6px;
    }

    /* TYPO + EFEKTY */
    .math var{font-style:italic}
    .math sub{font-style:normal}
    .phi{font-family:"Cambria Math","STIX Two Math","DejaVu Sans",serif}
    .shake{animation:shake .35s}
    .flash{animation:flash .4s}
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-4px)}
      80%{transform:translateX(4px)}
    }
    @keyframes flash{
      0%{background:#2b1111}
      100%{background:transparent}
    }

    /* ISKRA */
    .spark{
      position:absolute;
      width:160px;height:160px;
      pointer-events:none;
      display:none;
      background:
        radial-gradient(circle at 50% 50%,#FFD745 0 30%,rgba(255,215,69,.6) 35% 55%,transparent 60%),
        conic-gradient(from 0deg,rgba(255,215,69,.9),rgba(243,190,87,.6),rgba(255,237,154,.7),rgba(255,215,69,.9));
      filter:blur(1px) drop-shadow(0 0 10px rgba(255,215,69,.7));
      border-radius:50%;
      transform:translate(-50%,-50%) scale(.8);
      animation:spark .6s ease-out forwards;
    }
    @keyframes spark{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.4) rotate(0deg)}
      20%{opacity:1;transform:translate(-50%,-50%) scale(1.05) rotate(12deg)}
      100%{opacity:0;transform:translate(-50%,-50%) scale(1.1) rotate(22deg)}
    }
  </style>
</head>
<body>
  <main class="frame">
    <!-- Horn√Ω rad -->
    <section class="row top">
      <div class="panel dr" id="dr">
        <strong>Dr. Phasor</strong>
      </div>

      <div class="panel task" id="taskPanel">
        <div class="bubble wide" id="bubble">
          MUHAHA! Nov√© zadanie ƒçak√°‚Ä¶
          <div class="close" id="bubbleClose">√ó</div>
        </div>
        <h2>√öloha</h2>
        <div class="scroll math" id="taskText">
          <!-- bude prep√≠san√© v newTask1() -->
        </div>
      </div>

      <div class="panel student">
        <strong>≈†tudent</strong>
        <div class="locks" aria-label="Z√°mky" id="locksCol">
          <div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div>
          <div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div><div class="lock">üîí</div>
        </div>
      </div>
    </section>

    <!-- Pl√°tno -->
    <section class="play">
      <div class="workbench">
        <!-- ƒΩav√° z√≥na: osciloskop -->
        <div class="zone left">
          <div class="scope">
            <canvas id="osc" aria-label="osciloskop"></canvas>
          </div>
          <div class="osc-ui">
            <button id="playBtn" type="button">‚ñ∂Ô∏é Play</button>
            <label>ƒåas <var>t</var>:
              <input id="tSlider" type="range" min="0" max="20" step="0.1" value="2">
              <span id="tReadout">2.0 ms</span>
            </label>
          </div>
        </div>

        <!-- Prav√° z√≥na: kalkulaƒçka + odpoveƒè -->
        <div class="zone right">
          <div class="calc">
            <div class="calc-top">
              <input id="calcDisplay" type="text" inputmode="decimal" autocomplete="off" spellcheck="false" />
              <button id="degRad">RAD</button>
            </div>
           <div class="calc-grid">
  <!-- horn√Ω rad -->
  <button data-fn="pi">œÄ</button>
  <button data-fn="pow10">10‚Åø</button>
  <button data-op="^">^</button>
  <button data-fn="del">DEL</button>

  <!-- druh√Ω rad -->
  <button data-fn="sin">sin</button>
  <button data-fn="cos">cos</button>
  <button data-fn="tan">tan</button>
  <button data-fn="sqrt">‚àö</button>

  <!-- tret√≠ rad -->
  <button data-num="7">7</button>
  <button data-num="8">8</button>
  <button data-num="9">9</button>
  <button data-op="/">√∑</button>

  <!-- ≈°tvrt√Ω rad -->
  <button data-num="4">4</button>
  <button data-num="5">5</button>
  <button data-num="6">6</button>
  <button data-op="*">√ó</button>

  <!-- piaty rad -->
  <button data-num="1">1</button>
  <button data-num="2">2</button>
  <button data-num="3">3</button>
  <button data-op="-">‚àí</button>

  <!-- ≈°iesty rad -->
  <button data-num="0">0</button>
  <button data-op=".">.</button>
  <button data-op="(">(</button>
  <button data-op=")">)</button>

  <!-- spodn√Ω rad -->
  <button data-fn="clear" class="ghost">C</button>
  <button data-fn="ans" class="ghost">‚Üí Odpoveƒè</button>
  <button data-fn="eq" class="emph">=</button>
</div>
      </div>
           <div class="answerBox">
            <label>Odpoveƒè: <var>u</var>(<var>t</var>) =
              <input id="answer" type="number" step="0.01" placeholder="V">
              <span>V</span>
            </label>
            <button id="checkBtn">Skontrolova≈•</button>
            <div id="feedback" class="feedback"></div>
          </div>
        </div>

      <div id="spark" class="spark" aria-hidden="true"></div>
    </section>

    <!-- HUD -->
    <section class="hud">
      <div class="group">
        <span class="pill" id="timePill">TIME: 00:00</span>
        <span class="pill">
          MODE:
          <select id="modeSelect" style="margin-left:6px">
            <option value="EASY" selected>EASY</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HARD">HARD</option>
          </select>
        </span>
        <span class="pill" id="mistakesPill">MISTAKES: 0/2</span>
        <span class="pill" id="locksPill">LOCKS LEFT: 10</span>
      </div>
      <div class="group">
        <button class="pill" id="hintBtn">HINT</button>
      </div>
    </section>
  </main>

  <script>
    // bublina
    document.getElementById('bubbleClose')
      .addEventListener('click',()=>document.getElementById('bubble').style.display='none');

    /* ===== Stav ===== */
    const pills = {
      mistakes: document.getElementById('mistakesPill'),
      locks: document.getElementById('locksPill'),
      time: document.getElementById('timePill')
    };

    const state = {
      mode:'EASY',
      mistakes:0,
      U:230,
      f:50,
      phi:10,
      tGiven:2.0,
      playing:false,
      tAnim:2.0
    };

    const el = {
      taskText:document.getElementById('taskText'),
      tSlider:document.getElementById('tSlider'),
      tRead:document.getElementById('tReadout'),
      play:document.getElementById('playBtn'),
      answer:document.getElementById('answer'),
      check:document.getElementById('checkBtn'),
      feedback:document.getElementById('feedback'),
      taskPanel:document.getElementById('taskPanel'),
      bubble:document.getElementById('bubble'),
      osc:document.getElementById('osc'),
      spark:document.getElementById('spark'),
      locksCol:document.getElementById('locksCol'),
      modeSelect:document.getElementById('modeSelect')
    };

    const TAU = Math.PI*2;
    const deg2rad = d=>d*Math.PI/180;
    const round2 = x=>Math.round(x*100)/100;
    const randFrom = a=>a[Math.floor(Math.random()*a.length)];
    function tolByMode(){
      return state.mode==='EASY' ? 0.50 :
             state.mode==='MEDIUM' ? 0.20 : 0.05;
    }

    /* ===== Zadanie 1 ===== */
    function newTask1(){
      state.mistakes = 0;
      state.U   = randFrom([230,120,100,60]);
      state.f   = 50;
      state.phi = randFrom([-30,-15,0,10,15,30]);
      const Tms = 1000/state.f;
      state.tGiven = +(Math.random()*Tms).toFixed(1);

      el.taskText.innerHTML =
        `Vypoƒç√≠taj <var>u</var>(<var>t</var>) v ƒçase ${state.tGiven.toFixed(1)} ms.`+
        `<br>Vzorec: <var>u</var>(<var>t</var>) = <var>U</var><sub>m</sub> sin(<var>œât</var> + <span class="phi">œÜ</span>),`+
        ` kde <var>U</var><sub>m</sub> = ‚àö2 ¬∑ <var>U</var>.`+
        `<br>Parametre: <var>U</var> = ${state.U} V, <var>f</var> = ${state.f} Hz, <span class="phi">œÜ</span> = ${state.phi}¬∞.`;

      el.tSlider.max = Tms.toFixed(1);
      el.tSlider.value = state.tGiven;
      el.tRead.textContent = state.tGiven.toFixed(1)+' ms';
      state.tAnim = state.tGiven;

      el.answer.value = '';
      el.feedback.textContent = '';
      drawOsc();
      updateHud();
    }

    function u_of_t_ms(tms){
      const Um = Math.SQRT2 * state.U;
      const w  = TAU * state.f;
      const t  = tms / 1000;
      const phi = deg2rad(state.phi);
      return Um * Math.sin(w*t + phi);
    }

    /* ===== Osciloskop ===== */
    let oscCtx = null, DPR = window.devicePixelRatio || 1;
    let rafId = null, lastTs = 0, audioCtx = null;

    function resizeOsc(){
      const r = el.osc.getBoundingClientRect();
      el.osc.width  = Math.floor(r.width  * DPR);
      el.osc.height = Math.floor(r.height * DPR);
      oscCtx = el.osc.getContext('2d');
    }

    const SCOPE_STYLE = {
      gridFine:'rgba(255,255,255,0.22)',
      gridBold:'rgba(255,255,255,0.38)',
      axis:'#f9fafb',
      axisW:2.6,
      sineW:2.4
    };

    function drawOsc(){
      if(!oscCtx) resizeOsc();

      const W = el.osc.width / DPR;
      const H = el.osc.height / DPR;

      oscCtx.save();
      oscCtx.scale(DPR, DPR);
      oscCtx.clearRect(0,0,W,H);

      const G = 20;
      const PAD = 2*G;
      const xmin = PAD, xmax = W-PAD;
      const ymin = PAD, ymax = H-PAD;
      const midX = (xmin+xmax)/2;
      const midY = (ymin+ymax)/2;

      // mrie≈æka
      oscCtx.lineWidth = 1;
      oscCtx.strokeStyle = SCOPE_STYLE.gridFine;
      for(let x=Math.ceil(xmin/G)*G; x<=xmax; x+=G){
        oscCtx.beginPath(); oscCtx.moveTo(x,ymin); oscCtx.lineTo(x,ymax); oscCtx.stroke();
      }
      for(let y=Math.ceil(ymin/G)*G; y<=ymax; y+=G){
        oscCtx.beginPath(); oscCtx.moveTo(xmin,y); oscCtx.lineTo(xmax,y); oscCtx.stroke();
      }
      const G10 = 10*G;
      oscCtx.lineWidth = 1.4;
      oscCtx.strokeStyle = SCOPE_STYLE.gridBold;
      for(let x=Math.ceil(xmin/G10)*G10; x<=xmax; x+=G10){
        oscCtx.beginPath(); oscCtx.moveTo(x,ymin); oscCtx.lineTo(x,ymax); oscCtx.stroke();
      }
      for(let y=Math.ceil(ymin/G10)*G10; y<=ymax; y+=G10){
        oscCtx.beginPath(); oscCtx.moveTo(xmin,y); oscCtx.lineTo(xmax,y); oscCtx.stroke();
      }

      // osi
      oscCtx.strokeStyle = SCOPE_STYLE.axis;
      oscCtx.lineWidth = SCOPE_STYLE.axisW;
      oscCtx.beginPath(); oscCtx.moveTo(xmin,midY); oscCtx.lineTo(xmax,midY); oscCtx.stroke();
      oscCtx.beginPath(); oscCtx.moveTo(midX,ymin); oscCtx.lineTo(midX,ymax); oscCtx.stroke();

      // s√≠nus
      const T = 1/state.f;
      const viewT = 2*T;
      const tToX = t => xmin + (t/viewT)*(xmax-xmin);
      const A = (ymax-ymin)*0.28;
      const phi = deg2rad(state.phi);
      const w = TAU*state.f;

      oscCtx.strokeStyle = '#22c55e';
      oscCtx.lineWidth = SCOPE_STYLE.sineW;
      oscCtx.beginPath();
      const STEPS = Math.max(240, Math.floor(xmax-xmin));
      for(let i=0;i<=STEPS;i++){
        const x = xmin + (i/STEPS)*(xmax-xmin);
        const t = ((x-xmin)/(xmax-xmin))*viewT;
        const y = midY - A*Math.sin(w*t + phi);
        if(i===0) oscCtx.moveTo(x,y); else oscCtx.lineTo(x,y);
      }
      oscCtx.stroke();

      // bodka
      const Tms = 1000/state.f;
      const tms = state.playing ? state.tAnim : +el.tSlider.value;
      const t = (tms/1000) % viewT;
      const bx = tToX(t);
      const by = midY - A*Math.sin(w*t + phi);
      oscCtx.fillStyle = '#a7f3d0';
      oscCtx.beginPath(); oscCtx.arc(bx,by,4,0,TAU); oscCtx.fill();

      // text
     // const uval = u_of_t_ms(tms);
     // oscCtx.fillStyle = 'rgba(249,250,251,0.96)';
     // oscCtx.font = '600 12px system-ui';
     // oscCtx.fillText(`u(${tms.toFixed(1)} ms) ‚âà ${round2(uval).toFixed(2)} V`, xmin+4, ymin+14);

      oscCtx.restore();
    }

    function loop(ts){
      if(!state.playing){ rafId=null; return; }
      if(!lastTs) lastTs = ts;
      const dt = (ts-lastTs)/1000; lastTs = ts;

      const Tms = 1000/state.f;
      state.tAnim += dt*1000;
      if(state.tAnim >= Tms){ state.tAnim -= Tms; beep(); }

      el.tSlider.value = state.tAnim.toFixed(1);
      el.tRead.textContent = el.tSlider.value + ' ms';
      drawOsc();
      rafId = requestAnimationFrame(loop);
    }

    el.play.addEventListener('click',()=>{
      state.playing = !state.playing;
      el.play.textContent = state.playing ? '‚è∏Ô∏é Pause' : '‚ñ∂Ô∏é Play';
      el.play.classList.toggle('paused',!state.playing);
      if(state.playing){
        lastTs = 0;
        rafId = requestAnimationFrame(loop);
      }else if(rafId){
        cancelAnimationFrame(rafId); rafId=null;
      }
    });

    window.addEventListener('resize',()=>{ resizeOsc(); drawOsc(); });
    el.tSlider.addEventListener('input',e=>{
      const v = +e.target.value;
      el.tRead.textContent = v.toFixed(1)+' ms';
      if(!state.playing) state.tAnim = v;
      drawOsc();
    });

    function beep(){
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=880;
      g.gain.value=0.04;
      o.connect(g).connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime+0.08);
    }

    /* ===== Checker ===== */
    function updateHud(){
      const left = el.locksCol.querySelectorAll('.lock').length;
      pills.mistakes.textContent = `MISTAKES: ${state.mistakes}/2`;
      pills.locks.textContent    = `LOCKS LEFT: ${left}`;
    }

    function failFeedback(){
      el.taskPanel.classList.add('shake','flash');
      setTimeout(()=>el.taskPanel.classList.remove('shake','flash'),450);
    }

    function showMuhaha(){
      el.bubble.style.display='block';
      el.bubble.innerHTML = 'MUHAHA! Nov√© zadanie‚Ä¶<div class="close" id="bubbleClose2">√ó</div>';
      document.getElementById('bubbleClose2')
        .addEventListener('click',()=>el.bubble.style.display='none');
    }

    function dropOneLock(){
      const locks = el.locksCol.querySelectorAll('.lock');
      if(locks.length) locks[0].remove();
    }

    function successSpark(){
      const drRect = document.getElementById('dr').getBoundingClientRect();
      const frameRect = document.querySelector('.frame').getBoundingClientRect();
      el.spark.style.display='block';
      el.spark.style.left = (drRect.right - frameRect.left - 20)+'px';
      el.spark.style.top  = (drRect.top   - frameRect.top  + 30)+'px';
      setTimeout(()=>{ el.spark.style.display='none'; },650);
    }

    el.check.addEventListener('click',()=>{
      const ans = +el.answer.value;
      if(Number.isNaN(ans)){
        el.feedback.textContent='Zadaj ƒç√≠slo (V).';
        el.feedback.style.color=varFailColor();
        return;
      }
      const correct = round2(u_of_t_ms(state.tGiven));
      const given   = round2(ans);
      const tol     = tolByMode();
      if(Math.abs(given - correct) <= tol){
        el.feedback.textContent = `Spr√°vne! u(t) ‚âà ${correct.toFixed(2)} V üîì`;
        el.feedback.style.color = '#16a34a';
        dropOneLock();
        successSpark();
        newTask1();
      }else{
        state.mistakes++;
        if(state.mode==='EASY' && state.mistakes===1){
          el.feedback.textContent = 'N√°poveda: U_m = ‚àö2¬∑U, œâ=2œÄf, t v sekund√°ch.';
          el.feedback.style.color = '#b45309';
        }else if(state.mistakes>=2){
          el.feedback.textContent = 'MUHAHA! Nov√© zadanie.';
          el.feedback.style.color = '#ef4444';
          showMuhaha();
          newTask1();
        }else{
          el.feedback.textContent = 'Sk√∫s e≈°te raz.';
          el.feedback.style.color = '#ef4444';
        }
        failFeedback();
      }
      updateHud();
    });

    function varFailColor(){return '#ef4444';}

    el.modeSelect.addEventListener('change',e=>{
      state.mode = e.target.value;
    });

    // HINT tlaƒçidlo ‚Äì zatiaƒæ len jednoduch√Ω text v easy m√≥de
    document.getElementById('hintBtn').addEventListener('click',()=>{
      if(state.mode==='HARD'){
        el.feedback.textContent = 'V HARD m√≥de bez n√°povedy üòâ';
        el.feedback.style.color = '#e5e7eb';
      }else{
        el.feedback.textContent = 'Pou≈æi u(t)=U_m sin(œât+œÜ), U_m=‚àö2¬∑U, t preveƒè na sekundy.';
        el.feedback.style.color = '#38bdf8';
      }
    });

    // ƒçasovaƒç
    const startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const ss= String(s%60).padStart(2,'0');
      pills.time.textContent = `TIME: ${m}:${ss}`;
    },1000);

    /* ===== Kalkulaƒçka ===== */
    const calc = {
      disp: document.getElementById('calcDisplay'),
      modeBtn: document.getElementById('degRad'),
      grid: document.querySelector('.calc-grid'),
      rad: true
    };
    calc.modeBtn.addEventListener('click',()=>{
      calc.rad = !calc.rad;
      calc.modeBtn.textContent = calc.rad ? 'RAD' : 'DEG';
      calc.modeBtn.title = calc.rad ? 'Radi√°ny' : 'Stupne';
    });
    function insertToDisplay(s){ calc.disp.value += s; calc.disp.focus(); }
    function delOne(){ calc.disp.value = calc.disp.value.slice(0,-1); }
    function clearDisp(){ calc.disp.value=''; }
    function evalExpr(){
      let expr = calc.disp.value
        .replaceAll('^','**')
        .replaceAll('œÄ',Math.PI.toString())
        .replaceAll('e',Math.E.toString());
      const wrapTrig = fn => (calc.rad ? fn : x=>fn(x*Math.PI/180));
      const scope = {
        sin:x=>wrapTrig(Math.sin)(x),
        cos:x=>wrapTrig(Math.cos)(x),
        tan:x=>wrapTrig(Math.tan)(x),
        sqrt:Math.sqrt
      };
      try{
        const f = new Function('sin','cos','tan','sqrt',`return (${expr})`);
        const val = f(scope.sin,scope.cos,scope.tan,scope.sqrt);
        return Number.isFinite(val) ? val : NaN;
      }catch{ return NaN; }
    }
    calc.grid.addEventListener('click',e=>{
      const b = e.target.closest('button'); if(!b) return;
      const num = b.getAttribute('data-num');
      const op  = b.getAttribute('data-op');
      const fn  = b.getAttribute('data-fn');
      if(num!==null){ insertToDisplay(num); return; }
      if(op!==null){ insertToDisplay(op); return; }
      if(fn==='pi') insertToDisplay('œÄ');
      else if(fn==='pow10') insertToDisplay('*10^');
      else if(fn==='sin'||fn==='cos'||fn==='tan'||fn==='sqrt') insertToDisplay(fn+'(');
      else if(fn==='del') delOne();
      else if(fn==='clear') clearDisp();
      else if(fn==='eq'){
        const v = evalExpr();
        calc.disp.value = Number.isFinite(v) ? v : 'NaN';
      }else if(fn==='ans'){
        const v = evalExpr();
        if(Number.isFinite(v)){
          document.getElementById('answer').value = round2(v).toFixed(2);
        }
      }
    });

    /* ===== ≈†tart ===== */
    function boot(){
      resizeOsc();
      newTask1();
    }
    boot();
  </script>
</body>
</html>
